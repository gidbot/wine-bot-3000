<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üç∑ü§ñ Wine Bot 3000</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Y2K Color Palette */
            --bg-primary: #0a0a1a;
            --bg-secondary: #1a1a3a;
            --bg-card: rgba(255, 255, 255, 0.05);
            --border-subtle: rgba(0, 212, 255, 0.2);
            --text-primary: #e8e8e8;
            --text-secondary: #a0a0b0;
            --text-muted: #6a6a7a;
            
            /* Chrome/Metallic */
            --chrome-light: #e8e8e8;
            --chrome-mid: #c0c0c0;
            --chrome-dark: #808080;
            
            /* Electric Cyan (Primary) */
            --accent-cyan: #00d4ff;
            --accent-cyan-glow: rgba(0, 212, 255, 0.4);
            
            /* Hot Pink (Accent) */
            --accent-pink: #ff00aa;
            --accent-pink-glow: rgba(255, 0, 170, 0.4);
            
            /* Legacy mappings for compatibility */
            --accent-gold: var(--accent-cyan);
            --accent-gold-light: var(--accent-cyan);
            --accent-green: #00ff88;
            --accent-red: #ff3366;
            --accent-burgundy: #aa0055;
            --accent-purple: #aa00ff;
            --accent-orange: #ff6600;
            
            /* Glass effect */
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-blur: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Share Tech Mono', monospace;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-primary) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            background-attachment: fixed;
            position: relative;
        }

        /* Y2K Grid overlay effect */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(ellipse at 30% 20%, var(--accent-cyan-glow) 0%, transparent 40%),
                radial-gradient(ellipse at 70% 80%, var(--accent-pink-glow) 0%, transparent 40%),
                linear-gradient(rgba(0, 212, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 212, 255, 0.03) 1px, transparent 1px);
            background-size: 100% 100%, 100% 100%, 50px 50px, 50px 50px;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 60px 24px;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            margin-bottom: 48px;
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--chrome-light);
            letter-spacing: 0.05em;
            margin-bottom: 12px;
            text-transform: uppercase;
            text-shadow: 
                0 0 10px var(--accent-cyan-glow),
                0 0 20px var(--accent-cyan-glow),
                0 2px 0 var(--chrome-dark);
        }

        h1 span {
            background: linear-gradient(180deg, var(--accent-cyan) 0%, var(--accent-pink) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-family: 'Share Tech Mono', monospace;
            color: var(--accent-cyan);
            font-size: 1rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            opacity: 0.8;
        }

        /* Upload Section */
        .upload-section {
            margin-bottom: 48px;
        }

        .upload-zone {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 60px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        /* Metallic border effect */
        .upload-zone::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, var(--accent-cyan) 0%, transparent 50%, var(--accent-pink) 100%);
            border-radius: 22px;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .upload-zone:hover::before,
        .upload-zone.drag-over::before {
            opacity: 1;
        }

        .upload-zone:hover,
        .upload-zone.drag-over {
            border-color: transparent;
            background: rgba(0, 212, 255, 0.08);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                0 0 30px var(--accent-cyan-glow),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .upload-zone.drag-over {
            transform: scale(1.01);
        }

        .upload-icon {
            width: 72px;
            height: 72px;
            margin: 0 auto 20px;
            opacity: 0.8;
        }

        .upload-icon svg {
            width: 100%;
            height: 100%;
            stroke: var(--accent-cyan);
            stroke-width: 1.5;
            fill: none;
            filter: drop-shadow(0 0 8px var(--accent-cyan-glow));
        }

        .upload-text {
            font-size: 1.25rem;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .upload-hint {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .upload-buttons {
            margin-top: 24px;
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            font-family: 'Orbitron', sans-serif;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid var(--glass-border);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(180deg, var(--chrome-light) 0%, var(--chrome-mid) 50%, var(--chrome-dark) 100%);
            color: var(--bg-primary);
            border: 1px solid var(--chrome-light);
            box-shadow: 
                0 4px 15px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.8),
                inset 0 -1px 0 rgba(0, 0, 0, 0.2);
        }

        .btn-primary:hover {
            background: linear-gradient(180deg, #fff 0%, var(--chrome-light) 50%, var(--chrome-mid) 100%);
            box-shadow: 
                0 4px 20px rgba(0, 212, 255, 0.4),
                0 0 30px var(--accent-cyan-glow),
                inset 0 1px 0 rgba(255, 255, 255, 0.9),
                inset 0 -1px 0 rgba(0, 0, 0, 0.2);
        }

        .btn-secondary {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            color: var(--accent-cyan);
            border: 1px solid var(--accent-cyan);
            box-shadow: 
                0 4px 15px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        .btn-secondary:hover {
            background: rgba(0, 212, 255, 0.1);
            box-shadow: 
                0 4px 20px var(--accent-cyan-glow),
                0 0 20px var(--accent-cyan-glow),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .btn svg {
            width: 20px;
            height: 20px;
        }

        #file-input,
        #camera-input {
            display: none;
            visibility: hidden;
            position: absolute;
            pointer-events: none;
        }

        /* Preview Section */
        .preview-section {
            display: none;
            margin-bottom: 48px;
        }

        .preview-section.active {
            display: block;
        }

        .preview-card {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 24px;
            display: flex;
            gap: 24px;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .preview-image {
            width: 200px;
            height: 150px;
            object-fit: cover;
            border-radius: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
        }

        .preview-info {
            flex: 1;
            min-width: 200px;
        }

        .preview-filename {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .preview-size {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .preview-actions {
            display: flex;
            gap: 12px;
        }

        /* Context Input */
        .context-input-section {
            width: 100%;
            margin-bottom: 16px;
        }

        .context-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .context-label svg {
            opacity: 0.7;
        }

        .optional-tag {
            color: var(--text-muted);
            font-weight: 400;
        }

        .context-textarea {
            width: 100%;
            padding: 12px 14px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            resize: vertical;
            min-height: 60px;
            max-height: 150px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .context-textarea:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(201, 162, 39, 0.1);
        }

        .context-textarea::placeholder {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .context-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 6px;
        }

        /* Loading State */
        .loading-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: linear-gradient(180deg, rgba(10, 10, 26, 0.98) 0%, rgba(26, 26, 58, 0.98) 100%);
            backdrop-filter: blur(20px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 24px;
        }

        .loading-overlay::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 30% 30%, var(--accent-cyan-glow) 0%, transparent 50%),
                radial-gradient(circle at 70% 70%, var(--accent-pink-glow) 0%, transparent 50%);
            animation: pulseGlow 4s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes pulseGlow {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            text-align: center;
            max-width: 400px;
            width: 100%;
            position: relative;
            z-index: 1;
        }

        /* Wine Glass Animation */
        .wine-glass-icon {
            font-size: 4rem;
            margin-bottom: 24px;
            animation: robotPour 2s ease-in-out infinite;
            display: inline-block;
            filter: drop-shadow(0 0 20px var(--accent-cyan-glow));
        }

        @keyframes robotPour {
            0%, 100% { transform: rotate(-15deg) scale(1); }
            25% { transform: rotate(0deg) scale(1.05); }
            50% { transform: rotate(15deg) scale(1); }
            75% { transform: rotate(0deg) scale(1.05); }
        }

        .loading-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            color: var(--accent-cyan);
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            text-shadow: 0 0 10px var(--accent-cyan-glow);
        }

        .loading-subtext {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 24px;
            letter-spacing: 0.02em;
        }

        /* Progress Steps */
        .loading-steps {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .loading-step {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid rgba(0, 212, 255, 0.3);
            transition: all 0.3s ease;
        }

        .loading-step.active {
            background: var(--accent-cyan);
            box-shadow: 0 0 15px var(--accent-cyan-glow);
            transform: scale(1.2);
        }

        .loading-step.done {
            background: var(--accent-green);
            border-color: var(--accent-green);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.4);
        }

        /* Wine Discovery List */
        .wine-discovery {
            text-align: left;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
            max-height: 250px;
            overflow-y: auto;
            display: none;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .wine-discovery.visible {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .wine-discovery-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent-cyan);
            margin-bottom: 12px;
            text-shadow: 0 0 8px var(--accent-cyan-glow);
        }

        .wine-discovery-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .wine-discovery-item {
            padding: 8px 0;
            border-bottom: 1px solid rgba(0, 212, 255, 0.1);
            color: var(--text-primary);
            font-size: 0.9rem;
            opacity: 0;
            transform: translateX(-10px);
            animation: slideIn 0.3s ease forwards;
        }

        .wine-discovery-item:last-child {
            border-bottom: none;
        }

        /* Wine Lookup Progress */
        .wine-lookup-progress {
            display: none;
            text-align: left;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 16px;
            margin-top: 20px;
            max-height: 280px;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .wine-lookup-progress.visible {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .lookup-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(0, 212, 255, 0.2);
        }

        .lookup-progress-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--accent-cyan);
            text-shadow: 0 0 8px var(--accent-cyan-glow);
        }

        .lookup-progress-count {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.85rem;
            color: var(--accent-pink);
            text-shadow: 0 0 6px rgba(255, 0, 127, 0.5);
        }

        .lookup-current-wine {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 12px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.85rem;
            color: var(--text-primary);
            animation: pulse 1.5s ease infinite;
        }

        .lookup-current-wine .current-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent-cyan);
            display: block;
            margin-bottom: 4px;
        }

        .lookup-results {
            max-height: 150px;
            overflow-y: auto;
        }

        .lookup-result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid rgba(0, 212, 255, 0.1);
            font-size: 0.8rem;
            animation: slideIn 0.3s ease forwards;
        }

        .lookup-result-item:last-child {
            border-bottom: none;
        }

        .lookup-result-wine {
            color: var(--text-secondary);
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 10px;
        }

        .lookup-result-status {
            font-family: 'Share Tech Mono', monospace;
            font-weight: 600;
            white-space: nowrap;
        }

        .lookup-result-status.found {
            color: #00ff88;
        }

        .lookup-result-status.not-found {
            color: #ff6b6b;
        }

        .lookup-result-matched {
            display: block;
            font-size: 0.75rem;
            color: var(--accent-cyan);
            opacity: 0.8;
            margin-top: 2px;
        }

        .waiting-detail {
            display: block;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 4px;
            animation: pulse 1.5s ease infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .wine-discovery-item .wine-vintage {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-left: 8px;
        }

        .wine-discovery-item .wine-price {
            color: var(--accent-pink);
            float: right;
            text-shadow: 0 0 8px var(--accent-pink-glow);
        }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Staggered animation delays */
        .wine-discovery-item:nth-child(1) { animation-delay: 0.1s; }
        .wine-discovery-item:nth-child(2) { animation-delay: 0.2s; }
        .wine-discovery-item:nth-child(3) { animation-delay: 0.3s; }
        .wine-discovery-item:nth-child(4) { animation-delay: 0.4s; }
        .wine-discovery-item:nth-child(5) { animation-delay: 0.5s; }
        .wine-discovery-item:nth-child(6) { animation-delay: 0.6s; }
        .wine-discovery-item:nth-child(7) { animation-delay: 0.7s; }
        .wine-discovery-item:nth-child(8) { animation-delay: 0.8s; }
        .wine-discovery-item:nth-child(9) { animation-delay: 0.9s; }
        .wine-discovery-item:nth-child(10) { animation-delay: 1s; }

        /* Results Section */
        .results-section {
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .results-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--accent-cyan);
            text-shadow: 0 0 10px var(--accent-cyan-glow);
        }

        .results-meta {
            display: flex;
            gap: 24px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .results-meta span {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Table */
        .results-card {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
        }

        .results-table th {
            font-family: 'Orbitron', sans-serif;
            text-align: left;
            padding: 18px 16px;
            background: linear-gradient(180deg, rgba(0, 212, 255, 0.15) 0%, rgba(0, 0, 0, 0.3) 100%);
            color: var(--accent-cyan);
            font-weight: 500;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border-bottom: 1px solid var(--accent-cyan);
        }

        .results-table td {
            padding: 20px 16px;
            border-bottom: 1px solid rgba(0, 212, 255, 0.1);
            vertical-align: middle;
        }

        .results-table tbody tr:last-child td {
            border-bottom: none;
        }

        .results-table tbody tr:hover {
            background: rgba(0, 212, 255, 0.05);
        }

        .wine-name {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 1.05rem;
        }

        /* Hide mobile vintage on desktop - shown in separate column */
        .mobile-vintage {
            display: none;
        }

        .wine-unmatched {
            opacity: 0.6;
        }

        /* Matched Wine Column */
        .matched-wine {
            font-size: 0.9rem;
            color: var(--text-secondary);
            max-width: 250px;
        }

        .matched-wine-text {
            color: var(--accent-cyan);
            font-weight: 400;
        }

        .no-match {
            color: var(--text-muted);
            font-style: italic;
            opacity: 0.6;
        }

        /* Mobile matched wine display */
        .mobile-matched {
            display: none;
            font-size: 0.8rem;
            color: var(--accent-cyan);
            margin-top: 4px;
            padding-top: 4px;
            border-top: 1px dashed rgba(0, 212, 255, 0.2);
            font-style: italic;
        }

        .mobile-matched.no-match {
            color: var(--text-muted);
            opacity: 0.6;
        }

        .wine-vintage {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .price {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
            font-size: 1rem;
        }

        .price-menu {
            color: var(--accent-gold-light);
        }

        .price-retail {
            color: var(--accent-green);
        }

        .markup {
            font-weight: 600;
        }

        .markup-high {
            color: var(--accent-red);
        }

        .markup-medium {
            color: #ff9f0a;
        }

        .markup-low {
            color: var(--accent-green);
        }

        .markup-dollars {
            display: block;
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 400;
        }

        .na {
            color: var(--text-muted);
            font-style: italic;
            font-size: 0.9rem;
        }

        /* Glass Pour Styling */
        .glass-price-display {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 2px;
            font-size: 0.85rem;
        }

        .glass-original {
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .glass-arrow {
            display: none;
        }

        .glass-estimated {
            color: var(--accent-purple);
            font-weight: 600;
        }

        .glass-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 500;
            background: rgba(175, 82, 222, 0.2);
            color: var(--accent-purple);
            margin-top: 2px;
        }

        .glass-badge.auto {
            background: rgba(255, 159, 10, 0.2);
            color: var(--accent-orange);
        }

        .price-menu.is-glass {
            background: rgba(175, 82, 222, 0.05);
        }

        /* Expandable Rows */
        .wine-row {
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .wine-row:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .wine-row.expanded {
            background: rgba(201, 162, 39, 0.05);
        }

        .wine-row .expand-icon {
            display: inline-block;
            width: 16px;
            margin-right: 8px;
            color: var(--text-muted);
            transition: transform 0.2s ease;
        }

        .wine-row.expanded .expand-icon {
            transform: rotate(90deg);
            color: var(--accent-gold);
        }

        .listings-detail-row {
            display: none;
        }

        .listings-detail-row.visible {
            display: table-row;
        }

        .listings-detail-row td {
            padding: 0;
            background: rgba(0, 0, 0, 0.2);
        }

        .listings-detail-content {
            padding: 16px 24px;
        }

        .listings-detail-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .listings-detail-table th {
            text-align: left;
            padding: 8px 12px;
            color: var(--text-muted);
            font-weight: 500;
            font-size: 0.75rem;
            text-transform: uppercase;
            border-bottom: 1px solid var(--border-subtle);
        }

        .listings-detail-table td {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        }

        .listings-detail-table tbody tr:last-child td {
            border-bottom: none;
        }

        .listing-retailer {
            color: var(--text-primary);
            font-weight: 500;
        }

        .listing-price {
            color: var(--accent-green);
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
        }

        .listing-location {
            color: var(--text-muted);
        }

        .listing-link {
            color: var(--accent-gold);
            text-decoration: none;
            font-size: 0.8rem;
        }

        .listing-link:hover {
            text-decoration: underline;
        }

        .no-listings-msg {
            color: var(--text-muted);
            font-style: italic;
            padding: 12px 0;
        }

        /* Sortable Headers */
        .sortable {
            cursor: pointer;
            user-select: none;
            transition: color 0.2s ease;
            white-space: nowrap;
        }

        .sortable:hover {
            color: var(--accent-gold);
        }

        .sortable.active {
            color: var(--accent-gold);
        }

        .sort-icon {
            display: inline-block;
            margin-left: 4px;
            font-size: 0.7rem;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .sortable.active .sort-icon {
            opacity: 1;
        }

        /* Error State */
        .error-message {
            display: none;
            background: linear-gradient(145deg, rgba(255, 51, 102, 0.15), rgba(255, 51, 102, 0.05));
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--accent-red);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 0 20px rgba(255, 51, 102, 0.2);
        }

        .error-message.active {
            display: block;
        }
        
        .error-message.timeout {
            background: linear-gradient(145deg, rgba(255, 102, 0, 0.15), rgba(255, 102, 0, 0.05));
            border-color: var(--accent-orange);
            box-shadow: 0 0 20px rgba(255, 102, 0, 0.2);
        }
        
        .error-message.network, .error-message.connection_error {
            background: linear-gradient(145deg, rgba(255, 102, 0, 0.15), rgba(255, 102, 0, 0.05));
            border-color: var(--accent-orange);
            box-shadow: 0 0 20px rgba(255, 102, 0, 0.2);
        }

        .error-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .error-icon {
            font-size: 1.5rem;
        }
        
        .error-header strong {
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .error-text {
            color: var(--text-secondary);
            margin-bottom: 16px;
            line-height: 1.5;
        }
        
        .error-suggestions {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            display: none;
        }
        
        .error-suggestions.active {
            display: block;
        }
        
        .error-suggestions ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .error-suggestions li {
            color: var(--text-muted);
            font-size: 0.85rem;
            padding: 4px 0;
            padding-left: 20px;
            position: relative;
        }
        
        .error-suggestions li::before {
            content: "‚Üí";
            position: absolute;
            left: 0;
            color: var(--accent-gold);
        }
        
        .error-retry-btn {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-subtle);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .error-retry-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }

        /* No Wines Found State */
        .no-wines-found {
            display: none;
            text-align: center;
            padding: 60px 24px;
            background: linear-gradient(145deg, rgba(30, 30, 35, 0.8), rgba(25, 25, 30, 0.9));
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            margin: 40px auto;
            max-width: 500px;
        }

        .no-wines-found.active {
            display: block;
        }

        .no-wines-icon {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.8;
        }

        .no-wines-found h2 {
            color: var(--text-primary);
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .no-wines-message {
            color: var(--text-muted);
            font-size: 1rem;
            margin-bottom: 24px;
        }

        .no-wines-suggestions {
            text-align: left;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 24px;
        }

        .no-wines-suggestions h3 {
            color: var(--accent-gold);
            font-size: 0.9rem;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .no-wines-suggestions ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .no-wines-suggestions li {
            color: var(--text-secondary);
            font-size: 0.9rem;
            padding: 8px 0;
            padding-left: 24px;
            position: relative;
        }

        .no-wines-suggestions li::before {
            content: "‚Üí";
            position: absolute;
            left: 0;
            color: var(--accent-gold);
        }

        .try-again-btn {
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-gold));
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .try-again-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(175, 82, 222, 0.3);
        }

        /* Share Toast */
        .share-toast {
            font-family: 'Orbitron', sans-serif;
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: linear-gradient(180deg, rgba(0, 255, 136, 0.9) 0%, rgba(0, 180, 100, 0.95) 100%);
            color: var(--bg-primary);
            padding: 14px 24px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: 
                0 4px 20px rgba(0, 255, 136, 0.4),
                0 0 30px rgba(0, 255, 136, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            z-index: 1001;
        }

        .share-toast.visible {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .share-toast-icon {
            font-size: 1.2rem;
        }

        /* Restaurant Name Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(180deg, rgba(26, 26, 58, 0.95) 0%, rgba(10, 10, 26, 0.98) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--accent-cyan);
            border-radius: 16px;
            padding: 32px;
            max-width: 420px;
            box-shadow: 
                0 0 40px var(--accent-cyan-glow),
                0 20px 60px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            width: 100%;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-content h3 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.25rem;
            margin-bottom: 12px;
            color: var(--accent-cyan);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            text-shadow: 0 0 10px var(--accent-cyan-glow);
        }

        .modal-content p {
            color: var(--text-secondary);
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .modal-content input {
            font-family: 'Share Tech Mono', monospace;
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.4);
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: 24px;
            transition: border-color 0.2s;
        }

        .modal-content input:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 15px var(--accent-cyan-glow);
        }

        .modal-content input::placeholder {
            color: var(--text-muted);
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-buttons .btn {
            padding: 12px 24px;
        }

        .modal-buttons .btn svg {
            width: 16px;
            height: 16px;
        }

        /* Wine Selection Modal */
        .wine-selection-modal {
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .selection-cap-notice {
            font-family: 'Share Tech Mono', monospace;
            background: rgba(255, 0, 170, 0.15);
            border: 1px solid var(--accent-pink);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            font-size: 0.85rem;
            color: var(--accent-pink);
            text-shadow: 0 0 8px var(--accent-pink-glow);
        }

        .selection-count {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            color: var(--accent-cyan);
            text-align: center;
            margin-bottom: 16px;
            padding: 8px;
            background: rgba(0, 212, 255, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        .selection-count #selected-count {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .wine-selection-list {
            flex: 1;
            overflow-y: auto;
            max-height: 400px;
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }

        .wine-selection-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border-bottom: 1px solid rgba(0, 212, 255, 0.1);
            transition: background 0.2s;
            cursor: pointer;
        }

        .wine-selection-item:last-child {
            border-bottom: none;
        }

        .wine-selection-item:hover {
            background: rgba(0, 212, 255, 0.05);
        }

        .wine-selection-item.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .wine-selection-item.disabled:hover {
            background: transparent;
        }

        .wine-selection-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid var(--accent-cyan);
            border-radius: 4px;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .wine-selection-item.selected .wine-selection-checkbox {
            background: var(--accent-cyan);
            box-shadow: 0 0 10px var(--accent-cyan-glow);
        }

        .wine-selection-checkbox::after {
            content: '';
            display: none;
            width: 6px;
            height: 10px;
            border: solid var(--bg-primary);
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
            margin-bottom: 2px;
        }

        .wine-selection-item.selected .wine-selection-checkbox::after {
            display: block;
        }

        .wine-selection-info {
            flex: 1;
            min-width: 0;
        }

        .wine-selection-name {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.95rem;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .wine-selection-details {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .wine-selection-details .vintage {
            color: var(--accent-cyan);
            margin-right: 8px;
        }

        .wine-selection-details .price {
            color: var(--accent-pink);
        }

        .wine-selection-details .glass-indicator {
            background: rgba(255, 0, 170, 0.2);
            color: var(--accent-pink);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-left: 8px;
        }

        #proceed-lookup:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Footer */
        footer {
            font-family: 'Orbitron', sans-serif;
            text-align: center;
            margin-top: 60px;
            padding-top: 24px;
            border-top: 1px solid rgba(0, 212, 255, 0.2);
            color: var(--accent-cyan);
            font-size: 0.8rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            text-shadow: 0 0 8px var(--accent-cyan-glow);
        }

        footer a {
            color: var(--accent-gold);
            text-decoration: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 24px 12px;
            }

            h1 {
                font-size: 1.75rem;
            }

            .subtitle {
                font-size: 0.95rem;
            }

            .upload-zone {
                padding: 32px 16px;
            }

            .upload-buttons {
                flex-direction: column;
                gap: 12px;
            }

            .btn {
                width: 100%;
                justify-content: center;
                min-height: 48px; /* Touch-friendly */
            }

            .results-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .results-title {
                font-size: 1.4rem;
            }

            .results-meta {
                gap: 16px;
                font-size: 0.8rem;
            }

            .results-card {
                border-radius: 12px;
                padding: 0;
                background: transparent;
                border: none;
                box-shadow: none;
                backdrop-filter: none;
            }

            /* Hide table header on mobile */
            .results-table thead {
                display: none;
            }

            .results-table {
                display: block;
            }

            .results-table tbody {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            /* Transform each row into a Y2K glass card */
            .results-table tbody tr.wine-row {
                display: block;
                background: var(--glass-bg);
                backdrop-filter: blur(8px);
                -webkit-backdrop-filter: blur(8px);
                border: 1px solid var(--glass-border);
                border-radius: 12px;
                padding: 16px;
                margin: 0;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            }

            .results-table tbody tr.wine-row:hover {
                background: rgba(0, 212, 255, 0.08);
                border-color: var(--accent-cyan);
            }

            /* Hide vintage column (shown inline with name) */
            .hide-mobile {
                display: none !important;
            }

            /* Wine name - full width at top of card */
            .results-table td.wine-name {
                display: block;
                width: 100%;
                font-size: 1rem;
                font-weight: 600;
                color: var(--text-primary);
                padding: 0 0 12px 0;
                border-bottom: 1px solid rgba(0, 212, 255, 0.2);
                margin-bottom: 12px;
                max-width: none;
                overflow: visible;
                text-overflow: unset;
                white-space: normal;
                line-height: 1.4;
            }

            /* Vintage shown inline with name on mobile */
            .mobile-vintage {
                display: block;
                font-size: 0.85rem;
                font-weight: 400;
                color: var(--accent-cyan);
                margin-top: 4px;
            }

            /* Show matched wine on mobile */
            .mobile-matched {
                display: block;
            }

            /* Price cells in a row */
            .results-table td.price,
            .results-table td.markup-cell {
                display: inline-flex;
                flex-direction: column;
                width: calc(33.33% - 8px);
                padding: 0;
                border: none;
                vertical-align: top;
            }

            /* Labels for mobile cards */
            .results-table td[data-label]::before {
                content: attr(data-label);
                display: block;
                font-family: 'Orbitron', sans-serif;
                font-size: 0.6rem;
                font-weight: 500;
                color: var(--accent-cyan);
                text-transform: uppercase;
                letter-spacing: 0.08em;
                margin-bottom: 4px;
                opacity: 0.8;
            }

            /* Don't show label for wine name */
            .results-table td.wine-name::before {
                display: none;
            }

            .price {
                font-size: 0.95rem;
            }

            .markup-dollars {
                display: inline;
                font-size: 0.8rem;
            }

            .expand-icon {
                display: none !important;
            }

            /* Hide detail rows on mobile */
            .results-table tbody tr.listings-detail-row {
                display: none !important;
            }

            .preview-card {
                flex-direction: column;
                text-align: center;
                padding: 16px;
            }

            .preview-image {
                width: 100%;
                max-width: 250px;
                height: 120px;
            }

            .preview-actions {
                flex-direction: column;
                width: 100%;
            }

            .listings-detail-content {
                padding: 12px;
                overflow-x: auto;
            }

            .listings-detail-table {
                font-size: 0.75rem;
                min-width: 400px;
            }

            /* Modal mobile optimization */
            .modal-overlay {
                padding: 16px;
                align-items: flex-end;
            }

            .modal-content {
                max-width: 100%;
                padding: 24px 20px;
                border-radius: 16px 16px 0 0;
                max-height: 90vh;
                overflow-y: auto;
            }

            .modal-content h3 {
                font-size: 1.3rem;
            }

            .modal-content p {
                font-size: 0.9rem;
            }

            .modal-content input {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 16px;
            }

            .modal-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .modal-buttons .btn {
                width: 100%;
                padding: 16px;
                justify-content: center;
            }

            /* Reorder buttons - Share first on mobile */
            .modal-buttons {
                flex-direction: column-reverse;
            }

            /* Wine selection modal mobile */
            .wine-selection-modal {
                max-height: 85vh;
            }

            .wine-selection-list {
                max-height: 50vh;
            }

            .wine-selection-item {
                padding: 12px 14px;
            }

            .wine-selection-name {
                font-size: 0.9rem;
            }

            .selection-cap-notice {
                font-size: 0.8rem;
                padding: 10px 12px;
            }
        }

        /* Extra small screens */
        @media (max-width: 480px) {
            .container {
                padding: 16px 8px;
            }

            h1 {
                font-size: 1.5rem;
            }

            .results-table tbody tr.wine-row {
                padding: 14px;
            }

            .results-table td.wine-name {
                font-size: 0.95rem;
                padding-bottom: 10px;
                margin-bottom: 10px;
            }

            .mobile-vintage {
                font-size: 0.8rem;
            }

            .results-table td.price,
            .results-table td.markup-cell {
                width: calc(33.33% - 6px);
            }

            .results-table td[data-label]::before {
                font-size: 0.65rem;
            }

            .price {
                font-size: 0.85rem;
            }

            .markup-dollars {
                font-size: 0.75rem;
            }
            
            /* Compact glass display on mobile */
            .glass-price-display {
                flex-direction: row;
                align-items: center;
                gap: 4px;
                flex-wrap: wrap;
            }
            
            .glass-original {
                font-size: 0.7rem;
            }
            
            .glass-arrow {
                display: inline;
                font-size: 0.65rem;
                color: var(--text-muted);
            }
            
            .glass-estimated {
                font-size: 0.8rem;
            }
            
            .glass-badge {
                font-size: 0.55rem;
                padding: 1px 4px;
            }
        }

        /* Scrollable table wrapper for mobile */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Reduced motion preference */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Fallback for devices that don't support backdrop-filter */
        @supports not (backdrop-filter: blur(12px)) {
            .upload-zone,
            .preview-card,
            .results-card,
            .wine-discovery,
            .wine-lookup-progress,
            .error-message,
            .modal-content,
            .share-toast {
                background: rgba(26, 26, 58, 0.95) !important;
            }
            
            .results-table tbody tr.wine-row {
                background: rgba(26, 26, 58, 0.9) !important;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading">
        <div class="loading-content">
            <div class="wine-glass-icon">üç∑ü§ñ</div>
            <div class="loading-steps">
                <div class="loading-step active" id="step-1"></div>
                <div class="loading-step" id="step-2"></div>
                <div class="loading-step" id="step-3"></div>
            </div>
            <div class="loading-text" id="loading-text">Scanning menu...</div>
            <div class="loading-subtext" id="loading-status">AI is reading your wine list</div>
            
            <!-- Wine extraction discovery list -->
            <div class="wine-discovery" id="wine-discovery">
                <div class="wine-discovery-title">Wines Found</div>
                <ul class="wine-discovery-list" id="wine-discovery-list">
                    <!-- Wines will be added here dynamically -->
                </ul>
            </div>
            
            <!-- Price lookup progress -->
            <div class="wine-lookup-progress" id="wine-lookup-progress">
                <div class="lookup-progress-header">
                    <span class="lookup-progress-title">Looking up prices</span>
                    <span class="lookup-progress-count" id="lookup-progress-count">0 / 0</span>
                </div>
                <div class="lookup-current-wine" id="lookup-current-wine">
                    <!-- Current wine being looked up -->
                </div>
                <div class="lookup-results" id="lookup-results">
                    <!-- Results will appear here -->
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>Wine Bot <span>3000</span></h1>
            <p class="subtitle">Snap a menu, reveal the markup</p>
        </header>

        <!-- Error Message -->
        <div class="error-message" id="error">
            <div class="error-header">
                <span class="error-icon" id="error-icon">‚ö†Ô∏è</span>
                <strong id="error-title">Error</strong>
            </div>
            <p class="error-text" id="error-text"></p>
            <div class="error-suggestions" id="error-suggestions">
                <!-- Populated dynamically -->
            </div>
            <button class="error-retry-btn" id="error-retry-btn">
                <span>üîÑ</span> Try Again
            </button>
        </div>

        <!-- No Wines Found State -->
        <div class="no-wines-found" id="no-wines-found">
            <div class="no-wines-icon">üç∑ü§ñ</div>
            <h2>No Wines Found</h2>
            <p class="no-wines-message">We couldn't identify any wines in this image.</p>
            <div class="no-wines-suggestions">
                <h3>Tips for better results:</h3>
                <ul id="suggestions-list">
                    <!-- Populated dynamically -->
                </ul>
            </div>
            <button class="try-again-btn" id="try-again-btn">
                <span>üì∑</span> Try Another Image
            </button>
        </div>

        <!-- Upload Section -->
        <section class="upload-section" id="upload-section">
            <div class="upload-zone" id="upload-zone">
                <div class="upload-icon">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                </div>
                <div class="upload-text">Drop your menu photo here</div>
                <div class="upload-hint">or click to browse ¬∑ supports JPG, PNG, HEIC</div>
                
                <div class="upload-buttons">
                    <button class="btn btn-primary" id="browse-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        Choose File
                    </button>
                    <button class="btn btn-secondary" id="camera-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                            <circle cx="12" cy="13" r="4"/>
                        </svg>
                        Take Photo
                    </button>
                </div>
            </div>
            <input type="file" id="file-input" accept="image/*">
            <input type="file" id="camera-input" accept="image/*" capture="environment">
        </section>

        <!-- Preview Section -->
        <section class="preview-section" id="preview-section">
            <div class="preview-card">
                <img class="preview-image" id="preview-image" src="" alt="Menu preview">
                <div class="preview-info">
                    <div class="preview-filename" id="preview-filename">menu.jpg</div>
                    <div class="preview-size" id="preview-size">2.4 MB</div>
                </div>
                
                <!-- Context Input -->
                <div class="context-input-section">
                    <label for="context-input" class="context-label">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="16" x2="12" y2="12"/>
                            <line x1="12" y1="8" x2="12.01" y2="8"/>
                        </svg>
                        Additional Context <span class="optional-tag">(optional)</span>
                    </label>
                    <textarea 
                        id="context-input" 
                        class="context-textarea" 
                        placeholder="Add any helpful info about this menu... e.g., 'This is a Sicilian wine list', 'The wines are from 2020-2022 vintages', 'Restaurant is in Italy'"
                        rows="2"
                    ></textarea>
                    <div class="context-hint">This helps identify wines more accurately</div>
                </div>
                
                <div class="preview-actions">
                    <button class="btn btn-primary" id="analyze-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="m21 21-4.35-4.35"/>
                        </svg>
                        Analyze Menu
                    </button>
                    <button class="btn btn-secondary" id="clear-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                        Clear
                    </button>
                </div>
            </div>
        </section>

        <!-- Results Section -->
        <section class="results-section" id="results-section">
            <div class="results-header">
                <h2 class="results-title">üç∑ü§ñ Markup Analysis</h2>
                <div class="results-meta">
                    <span id="total-wines">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M8 22h8M12 11v11M7.5 2h9l.25 6a4 4 0 0 1-4 4h-1.5a4 4 0 0 1-4-4l.25-6Z"/>
                        </svg>
                        0 wines found
                    </span>
                    <span id="matched-wines">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                        0 matched
                    </span>
                </div>
            </div>

            <div class="results-card">
                <div class="table-wrapper">
                    <table class="results-table">
                <thead>
                    <tr>
                        <th>Menu Wine</th>
                        <th class="hide-mobile">Matched Wine</th>
                        <th class="hide-mobile">Vintage</th>
                        <th class="sortable" data-sort="menu_price">
                            Menu
                            <span class="sort-icon"></span>
                        </th>
                        <th>Retail</th>
                        <th class="sortable active asc" data-sort="markup_percent">
                            Markup
                            <span class="sort-icon">‚ñ≤</span>
                        </th>
                    </tr>
                </thead>
                        <tbody id="results-body">
                            <!-- Results will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div style="margin-top: 24px; text-align: center;">
                <button class="btn btn-secondary" id="new-analysis-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    Analyze Another Menu
                </button>
                <button class="btn btn-primary" id="share-btn" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="18" cy="5" r="3"/>
                        <circle cx="6" cy="12" r="3"/>
                        <circle cx="18" cy="19" r="3"/>
                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                    </svg>
                    <span id="share-btn-text">Share Results</span>
                </button>
            </div>
            
            <!-- Share Success Toast -->
            <div class="share-toast" id="share-toast">
                <span class="share-toast-icon">üç∑ü§ñ</span>
                <span class="share-toast-text">Link copied to clipboard!</span>
            </div>
            
            <!-- Restaurant Name Modal -->
            <div class="modal-overlay" id="restaurant-modal">
                <div class="modal-content">
                    <h3>Share Analysis</h3>
                    <p>Enter the restaurant name to include with your shared link:</p>
                    <input type="text" id="restaurant-name-input" placeholder="e.g., The French Laundry" maxlength="100">
                    <div class="modal-buttons">
                        <button class="btn btn-secondary modal-cancel" id="modal-cancel">Cancel</button>
                        <button class="btn btn-primary modal-confirm" id="modal-confirm">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="18" cy="5" r="3"/>
                                <circle cx="6" cy="12" r="3"/>
                                <circle cx="18" cy="19" r="3"/>
                                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                            </svg>
                            Share
                        </button>
                    </div>
                </div>
            </div>
            
        </section>

        <footer>
            üç∑ü§ñ Wine Bot 3000
        </footer>
    </div>
    
    <!-- Wine Selection Modal (outside container for proper z-index) -->
    <div class="modal-overlay" id="wine-selection-modal">
        <div class="modal-content wine-selection-modal">
            <h3>üç∑ü§ñ Select Wines for Price Lookup</h3>
            <p class="selection-cap-notice">üç∑ü§ñ Select up to 10 wines. Price lookups are capped to manage API costs.</p>
            <div class="selection-count">
                <span id="selected-count">0</span>/10 selected
            </div>
            <div class="wine-selection-list" id="wine-selection-list">
                <!-- Dynamically populated -->
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="cancel-selection">Cancel</button>
                <button class="btn btn-primary" id="proceed-lookup" disabled>
                    üç∑ü§ñ Get Prices
                </button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const uploadZone = document.getElementById('upload-zone');
        const uploadSection = document.getElementById('upload-section');
        const previewSection = document.getElementById('preview-section');
        const resultsSection = document.getElementById('results-section');
        const fileInput = document.getElementById('file-input');
        const cameraInput = document.getElementById('camera-input');
        const browseBtn = document.getElementById('browse-btn');
        const cameraBtn = document.getElementById('camera-btn');
        const analyzeBtn = document.getElementById('analyze-btn');
        const clearBtn = document.getElementById('clear-btn');
        const newAnalysisBtn = document.getElementById('new-analysis-btn');
        const shareBtn = document.getElementById('share-btn');
        const shareBtnText = document.getElementById('share-btn-text');
        const shareToast = document.getElementById('share-toast');
        const previewImage = document.getElementById('preview-image');
        const previewFilename = document.getElementById('preview-filename');
        const previewSize = document.getElementById('preview-size');
        const loading = document.getElementById('loading');
        const loadingStatus = document.getElementById('loading-status');
        const loadingText = document.getElementById('loading-text');
        const wineDiscovery = document.getElementById('wine-discovery');
        const wineDiscoveryList = document.getElementById('wine-discovery-list');
        
        // Wine Lookup Progress Elements
        const wineLookupProgress = document.getElementById('wine-lookup-progress');
        const lookupProgressCount = document.getElementById('lookup-progress-count');
        const lookupCurrentWine = document.getElementById('lookup-current-wine');
        const lookupResults = document.getElementById('lookup-results');
        const errorDiv = document.getElementById('error');
        const errorIcon = document.getElementById('error-icon');
        const errorTitle = document.getElementById('error-title');
        const errorText = document.getElementById('error-text');
        const errorSuggestions = document.getElementById('error-suggestions');
        const errorRetryBtn = document.getElementById('error-retry-btn');
        const noWinesFound = document.getElementById('no-wines-found');
        const suggestionsList = document.getElementById('suggestions-list');
        const tryAgainBtn = document.getElementById('try-again-btn');
        const resultsBody = document.getElementById('results-body');
        const totalWinesSpan = document.getElementById('total-wines');
        const matchedWinesSpan = document.getElementById('matched-wines');
        
        // Wine Selection Modal Elements
        const wineSelectionModal = document.getElementById('wine-selection-modal');
        const wineSelectionList = document.getElementById('wine-selection-list');
        const selectedCountSpan = document.getElementById('selected-count');
        const cancelSelectionBtn = document.getElementById('cancel-selection');
        const proceedLookupBtn = document.getElementById('proceed-lookup');

        let currentFile = null;
        let currentBase64 = null;
        let isImageReady = false;  // Track if FileReader has completed
        let winesData = [];
        let currentResults = null;  // Store full results for sharing
        let currentSort = { field: 'markup_percent', direction: 'asc' };
        
        // Wine selection state
        let extractedWines = [];  // All wines extracted by Claude
        let selectedWineIndices = new Set();  // Indices of selected wines
        const MAX_WINES = 10;

        // Reusable SVG Icons
        const ICONS = {
            wine: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 22h8M12 11v11M7.5 2h9l.25 6a4 4 0 0 1-4 4h-1.5a4 4 0 0 1-4-4l.25-6Z"/></svg>',
            check: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>'
        };

        // Utility Functions
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function formatPrice(price) {
            if (price === null || price === undefined) return '<span class="na">N/A</span>';
            return '$' + price.toFixed(2);
        }
        
        function formatMenuPrice(wine) {
            if (wine.menu_price === null || wine.menu_price === undefined) {
                return '<span class="na">N/A</span>';
            }
            
            if (wine.is_glass) {
                // Show glass price with bottle estimation
                const glassPrice = wine.glass_price ? wine.glass_price.toFixed(2) : '?';
                const bottlePrice = wine.menu_price.toFixed(2);
                const indicator = wine.auto_detected_glass 
                    ? '<span class="glass-badge auto">ü•Ç auto</span>' 
                    : '<span class="glass-badge">ü•Ç glass</span>';
                return `<span class="glass-price-display">
                    <span class="glass-original">$${glassPrice}/gl</span>
                    <span class="glass-arrow">‚Üí</span>
                    <span class="glass-estimated">~$${bottlePrice}</span>
                    ${indicator}
                </span>`;
            }
            
            return '$' + wine.menu_price.toFixed(2);
        }

        function formatMarkupCombined(percent, dollars) {
            if (percent === null || percent === undefined) return '<span class="na">N/A</span>';
            
            let colorClass = 'markup-high';
            if (percent < 50) colorClass = 'markup-low';
            else if (percent < 100) colorClass = 'markup-medium';
            
            const dollarStr = dollars !== null ? `<span class="markup-dollars">$${dollars.toFixed(0)}</span>` : '';
            return `<span class="markup ${colorClass}">${percent.toFixed(0)}%</span>${dollarStr}`;
        }

        function formatSourceBadge(source) {
            // Source badge no longer needed - single source (price_stats)
            return '';
        }

        // Sorting Functions
        function sortWines(wines, field, direction) {
            return [...wines].sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];
                
                // Handle null/undefined values - always push to the end
                const aIsNull = aVal === null || aVal === undefined;
                const bIsNull = bVal === null || bVal === undefined;
                
                if (aIsNull && bIsNull) {
                    // Both are N/A - sort by menu price ascending
                    const aPrice = a.menu_price || 0;
                    const bPrice = b.menu_price || 0;
                    return aPrice - bPrice;
                }
                if (aIsNull) return 1;  // a goes to end
                if (bIsNull) return -1; // b goes to end
                
                if (direction === 'desc') {
                    return bVal - aVal;
                } else {
                    return aVal - bVal;
                }
            });
        }

        function updateSortUI(field) {
            document.querySelectorAll('.sortable').forEach(th => {
                th.classList.remove('active', 'asc', 'desc');
                th.querySelector('.sort-icon').textContent = '';
            });
            
            const activeHeader = document.querySelector(`[data-sort="${field}"]`);
            if (activeHeader) {
                activeHeader.classList.add('active', currentSort.direction);
                activeHeader.querySelector('.sort-icon').textContent = currentSort.direction === 'desc' ? '‚ñº' : '‚ñ≤';
            }
        }

        function handleSort(field) {
            if (currentSort.field === field) {
                // Toggle direction
                currentSort.direction = currentSort.direction === 'desc' ? 'asc' : 'desc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'desc';
            }
            
            updateSortUI(field);
            renderWinesTable();
        }

        function showError(message) {
            showErrorWithSuggestions(message, [], 'error');
        }
        
        function showErrorWithSuggestions(message, suggestions = [], errorType = 'error') {
            // Set icon and title based on error type
            const errorConfig = {
                'timeout': { icon: '‚è±Ô∏è', title: 'Request Timed Out' },
                'network': { icon: 'üì°', title: 'Connection Error' },
                'connection_error': { icon: 'üì°', title: 'Connection Error' },
                'validation_error': { icon: '‚ö†Ô∏è', title: 'Invalid Request' },
                'server_error': { icon: 'üîß', title: 'Server Error' },
                'error': { icon: '‚ö†Ô∏è', title: 'Error' }
            };
            
            const config = errorConfig[errorType] || errorConfig['error'];
            
            errorIcon.textContent = config.icon;
            errorTitle.textContent = config.title;
            errorText.textContent = message;
            
            // Remove previous type classes
            errorDiv.classList.remove('timeout', 'network', 'connection_error', 'validation_error', 'server_error');
            errorDiv.classList.add(errorType);
            
            // Show suggestions if any
            if (suggestions && suggestions.length > 0) {
                errorSuggestions.innerHTML = '<ul>' + suggestions.map(s => `<li>${s}</li>`).join('') + '</ul>';
                errorSuggestions.classList.add('active');
            } else {
                errorSuggestions.classList.remove('active');
            }
            
            errorDiv.classList.add('active');
        }

        function hideError() {
            errorDiv.classList.remove('active', 'timeout', 'network', 'connection_error', 'validation_error', 'server_error');
            errorSuggestions.classList.remove('active');
        }

        function showNoWinesFound(suggestions = []) {
            // Hide other sections
            resultsSection.classList.remove('active');
            uploadSection.classList.remove('hidden');
            previewSection.classList.remove('active');
            hideError();
            
            // Populate suggestions
            if (suggestions && suggestions.length > 0) {
                suggestionsList.innerHTML = suggestions.map(s => `<li>${s}</li>`).join('');
            } else {
                suggestionsList.innerHTML = `
                    <li>Make sure the image clearly shows a wine menu or wine list</li>
                    <li>Try taking a clearer photo with better lighting</li>
                    <li>Ensure wine names and prices are visible and readable</li>
                    <li>Crop the image to focus on the wine section</li>
                `;
            }
            
            noWinesFound.classList.add('active');
        }

        function hideNoWinesFound() {
            noWinesFound.classList.remove('active');
        }

        function showLoading(step, title, status) {
            loadingText.textContent = title;
            loadingStatus.textContent = status;
            loading.classList.add('active');
            
            // Update step indicators
            document.querySelectorAll('.loading-step').forEach((el, i) => {
                el.classList.remove('active', 'done');
                if (i < step - 1) el.classList.add('done');
                if (i === step - 1) el.classList.add('active');
            });
            
            // Hide panels based on step
            if (step === 1) {
                wineDiscovery.classList.remove('visible');
                wineDiscoveryList.innerHTML = '';
                wineLookupProgress.classList.remove('visible');
                lookupResults.innerHTML = '';
            }
        }
        
        // Wine lookup progress functions
        let lookupProgressInterval = null;
        let currentLookupIndex = 0;
        let lookupWinesList = [];
        let lookupStartTime = null;
        
        function startLookupProgress(wines) {
            lookupWinesList = wines;
            currentLookupIndex = 0;
            lookupResults.innerHTML = '';
            lookupProgressCount.textContent = `0 / ${wines.length}`;
            lookupStartTime = Date.now();
            
            // Show current wine being looked up
            updateCurrentLookupWine();
            
            wineLookupProgress.classList.add('visible');
            wineDiscovery.classList.remove('visible');
            
            // Start cycling through wines with timing info
            lookupProgressInterval = setInterval(() => {
                if (currentLookupIndex < lookupWinesList.length - 1) {
                    // Move to next wine
                    currentLookupIndex++;
                    updateCurrentLookupWine();
                } else {
                    // All wines shown, update to show waiting status
                    updateWaitingStatus();
                }
            }, 800); // Update every 800ms
        }
        
        function updateCurrentLookupWine() {
            const wine = lookupWinesList[currentLookupIndex];
            lookupProgressCount.textContent = `${currentLookupIndex + 1} / ${lookupWinesList.length}`;
            lookupCurrentWine.innerHTML = `
                <span class="current-label">Matching wine ${currentLookupIndex + 1} of ${lookupWinesList.length}:</span>
                ${wine.name || wine.wine_name}${wine.vintage ? ' ' + wine.vintage : ''}
            `;
        }
        
        function updateWaitingStatus() {
            const elapsed = Math.floor((Date.now() - lookupStartTime) / 1000);
            lookupCurrentWine.innerHTML = `
                <span class="current-label">Waiting for Wine Labs API...</span>
                <span class="waiting-detail">Fetching prices from database (${elapsed}s)</span>
            `;
        }
        
        function finishLookupProgress(results) {
            // Stop the interval
            if (lookupProgressInterval) {
                clearInterval(lookupProgressInterval);
                lookupProgressInterval = null;
            }
            
            // Clear the "currently looking up" display
            lookupCurrentWine.innerHTML = '';
            
            // Show final results
            lookupProgressCount.textContent = `${results.length} / ${results.length}`;
            
            // Display all results with match status
            lookupResults.innerHTML = results.map(wine => {
                const menuName = wine.wine_name || wine.name || 'Unknown';
                const matchedName = wine.matched_wine_name;
                const hasPrice = wine.retail_price !== null && wine.retail_price !== undefined;
                const statusClass = hasPrice ? 'found' : 'not-found';
                const statusText = hasPrice ? `$${wine.retail_price.toFixed(0)}` : 'No match';
                
                // Show matched wine name if found
                const matchLine = matchedName 
                    ? `<span class="lookup-result-matched">‚Üí ${matchedName}</span>` 
                    : '';
                
                return `
                    <div class="lookup-result-item">
                        <span class="lookup-result-wine">${menuName}${matchLine}</span>
                        <span class="lookup-result-status ${statusClass}">${statusText}</span>
                    </div>
                `;
            }).join('');
        }
        
        function stopLookupProgress() {
            if (lookupProgressInterval) {
                clearInterval(lookupProgressInterval);
                lookupProgressInterval = null;
            }
            wineLookupProgress.classList.remove('visible');
        }

        function showDiscoveredWines(wines) {
            // Update to step 2
            showLoading(2, 'Found ' + wines.length + ' wines!', 'Looking up prices...');
            
            // Build wine list HTML
            wineDiscoveryList.innerHTML = wines.map(wine => {
                const vintage = wine.vintage ? `<span class="wine-vintage">${wine.vintage}</span>` : '';
                const price = wine.price ? `<span class="wine-price">$${wine.price}</span>` : '';
                return `<li class="wine-discovery-item">${wine.name}${vintage}${price}</li>`;
            }).join('');
            
            // Show the discovery panel
            wineDiscovery.classList.add('visible');
        }

        function hideLoading() {
            loading.classList.remove('active');
            wineDiscovery.classList.remove('visible');
            stopLookupProgress();
        }

        // Wine Selection Modal Functions
        function showWineSelectionModal(wines) {
            extractedWines = wines;
            selectedWineIndices.clear();
            
            // Pre-select first 10 wines (or all if fewer)
            const preSelectCount = Math.min(wines.length, MAX_WINES);
            for (let i = 0; i < preSelectCount; i++) {
                selectedWineIndices.add(i);
            }
            
            renderWineSelectionList();
            updateSelectionCount();
            wineSelectionModal.classList.add('visible');
        }

        function hideWineSelectionModal() {
            wineSelectionModal.classList.remove('visible');
            extractedWines = [];
            selectedWineIndices.clear();
        }

        function renderWineSelectionList() {
            wineSelectionList.innerHTML = extractedWines.map((wine, index) => {
                const isSelected = selectedWineIndices.has(index);
                const isDisabled = !isSelected && selectedWineIndices.size >= MAX_WINES;
                
                const vintage = wine.vintage ? `<span class="vintage">${wine.vintage}</span>` : '';
                const price = wine.menu_price ? `<span class="price">$${wine.menu_price}</span>` : '';
                const glassIndicator = wine.is_glass ? '<span class="glass-indicator">ü•Ç Glass</span>' : '';
                
                return `
                    <div class="wine-selection-item ${isSelected ? 'selected' : ''} ${isDisabled ? 'disabled' : ''}" 
                         data-index="${index}">
                        <div class="wine-selection-checkbox"></div>
                        <div class="wine-selection-info">
                            <div class="wine-selection-name">${wine.name || wine.original_name}</div>
                            <div class="wine-selection-details">
                                ${vintage}${price}${glassIndicator}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add click handlers to items
            wineSelectionList.querySelectorAll('.wine-selection-item').forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.dataset.index);
                    toggleWineSelection(index);
                });
            });
        }

        function toggleWineSelection(index) {
            if (selectedWineIndices.has(index)) {
                // Deselect
                selectedWineIndices.delete(index);
            } else if (selectedWineIndices.size < MAX_WINES) {
                // Select (only if under limit)
                selectedWineIndices.add(index);
            }
            // If at limit and trying to select, do nothing
            
            renderWineSelectionList();
            updateSelectionCount();
        }

        function updateSelectionCount() {
            selectedCountSpan.textContent = selectedWineIndices.size;
            proceedLookupBtn.disabled = selectedWineIndices.size === 0;
        }

        function getSelectedWines() {
            return Array.from(selectedWineIndices)
                .sort((a, b) => a - b)
                .map(index => extractedWines[index]);
        }

        // Wine Selection Modal Event Listeners
        cancelSelectionBtn.addEventListener('click', () => {
            hideWineSelectionModal();
            hideLoading();
            // Reset to preview state
            analyzeBtn.disabled = false;
            analyzeBtn.textContent = 'Analyze Menu';
        });

        // File Handling
        function handleFile(file) {
            if (!file) return;
            
            hideError();
            hideNoWinesFound();
            
            // Validate file type
            const validTypes = ['image/jpeg', 'image/png', 'image/heic', 'image/heif', 'image/webp'];
            if (!validTypes.includes(file.type) && !file.name.match(/\.(jpg|jpeg|png|heic|heif|webp)$/i)) {
                showError('Please upload an image file (JPG, PNG, HEIC, or WebP)');
                return;
            }

            currentFile = file;
            isImageReady = false;  // Reset ready state
            
            // Disable analyze button while loading
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'Loading...';
            
            // Create preview
            const reader = new FileReader();
            reader.onload = function(e) {
                currentBase64 = e.target.result;
                previewImage.src = currentBase64;
                previewFilename.textContent = file.name;
                previewSize.textContent = formatFileSize(file.size);
                
                uploadSection.style.display = 'none';
                previewSection.classList.add('active');
                resultsSection.classList.remove('active');
                
                // Mark image as ready and enable analyze button
                isImageReady = true;
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'Analyze Menu';
            };
            reader.onerror = function(e) {
                console.error('FileReader error:', e);
                showError('Failed to load image. Please try again.');
                isImageReady = false;
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'Analyze Menu';
            };
            reader.readAsDataURL(file);
        }

        // Drag and Drop
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('drag-over');
        });

        uploadZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            handleFile(file);
        });

        // Click handlers
        uploadZone.addEventListener('click', (e) => {
            if (e.target === uploadZone || e.target.closest('.upload-icon') || 
                e.target.closest('.upload-text') || e.target.closest('.upload-hint')) {
                fileInput.click();
            }
        });

        browseBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            fileInput.click();
        });

        cameraBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            cameraInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            handleFile(e.target.files[0]);
        });

        cameraInput.addEventListener('change', (e) => {
            handleFile(e.target.files[0]);
        });

        clearBtn.addEventListener('click', () => {
            currentFile = null;
            currentBase64 = null;
            isImageReady = false;
            fileInput.value = '';
            cameraInput.value = '';
            previewSection.classList.remove('active');
            uploadSection.style.display = 'block';
            hideError();
            analyzeBtn.disabled = false;
            analyzeBtn.textContent = 'Analyze Menu';
        });

        newAnalysisBtn.addEventListener('click', () => {
            currentFile = null;
            currentBase64 = null;
            isImageReady = false;
            currentResults = null;
            fileInput.value = '';
            cameraInput.value = '';
            previewSection.classList.remove('active');
            resultsSection.classList.remove('active');
            uploadSection.style.display = 'block';
            analyzeBtn.disabled = false;
            analyzeBtn.textContent = 'Analyze Menu';
            shareBtn.style.display = 'none';
            hideError();
        });

        // Restaurant name modal elements
        const restaurantModal = document.getElementById('restaurant-modal');
        const restaurantNameInput = document.getElementById('restaurant-name-input');
        const modalCancel = document.getElementById('modal-cancel');
        const modalConfirm = document.getElementById('modal-confirm');

        // Share button handler - show modal first
        shareBtn.addEventListener('click', () => {
            if (!currentBase64 || !currentResults) {
                showError('No analysis to share');
                return;
            }
            
            // Show restaurant name modal
            restaurantNameInput.value = '';
            restaurantModal.classList.add('visible');
            restaurantNameInput.focus();
        });

        // Modal cancel button
        modalCancel.addEventListener('click', () => {
            restaurantModal.classList.remove('visible');
        });

        // Close modal on overlay click
        restaurantModal.addEventListener('click', (e) => {
            if (e.target === restaurantModal) {
                restaurantModal.classList.remove('visible');
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && restaurantModal.classList.contains('visible')) {
                restaurantModal.classList.remove('visible');
            }
        });

        // Modal confirm button - proceed with share
        modalConfirm.addEventListener('click', async () => {
            const restaurantName = restaurantNameInput.value.trim();
            
            if (!restaurantName) {
                restaurantNameInput.style.borderColor = 'var(--accent-red)';
                restaurantNameInput.focus();
                setTimeout(() => {
                    restaurantNameInput.style.borderColor = '';
                }, 2000);
                return;
            }
            
            // Close modal
            restaurantModal.classList.remove('visible');
            
            // Update button state
            shareBtnText.textContent = 'Saving...';
            shareBtn.disabled = true;
            
            try {
                // Safely extract media type and image data
                const { mediaType, imageData } = parseDataUrl(currentBase64);
                
                const response = await fetch('/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image: imageData,
                        media_type: mediaType,
                        results: currentResults,
                        restaurant_name: restaurantName
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok || data.error) {
                    throw new Error(data.error || 'Failed to save');
                }
                
                // Build shareable URL
                const shareUrl = `${window.location.origin}/share/${data.id}`;
                
                // Copy to clipboard with fallbacks
                const copyResult = await copyToClipboard(shareUrl);
                
                if (copyResult.success) {
                    // Show success toast
                    showShareToast();
                    shareBtnText.textContent = 'Link Copied!';
                    
                    // Redirect to share page after brief delay
                    setTimeout(() => {
                        window.location.href = shareUrl;
                    }, 1000);
                } else {
                    // Fallback: show manual copy modal, then redirect
                    showManualCopyModal(shareUrl);
                    shareBtnText.textContent = 'Link Ready!';
                    
                    // Still redirect after a bit longer for manual copy
                    setTimeout(() => {
                        window.location.href = shareUrl;
                    }, 2000);
                }
                
            } catch (error) {
                console.error('Share error:', error);
                shareBtnText.textContent = 'Share Failed';
                setTimeout(() => {
                    shareBtnText.textContent = 'Share Results';
                    shareBtn.disabled = false;
                }, 3000);
            }
        });
        
        // Allow Enter key to confirm in modal
        restaurantNameInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                modalConfirm.click();
            }
        });
        
        function showShareToast() {
            shareToast.classList.add('visible');
            setTimeout(() => {
                shareToast.classList.remove('visible');
            }, 3000);
        }

        // Robust clipboard copy with fallbacks for mobile
        async function copyToClipboard(text) {
            // Method 1: Modern Clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                try {
                    await navigator.clipboard.writeText(text);
                    return { success: true, method: 'clipboard' };
                } catch (e) {
                    console.log('Clipboard API failed, trying fallback:', e);
                }
            }
            
            // Method 2: execCommand fallback (works on more mobile browsers)
            try {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                textArea.style.top = '0';
                textArea.setAttribute('readonly', ''); // Prevent keyboard on mobile
                document.body.appendChild(textArea);
                
                // iOS specific handling
                const range = document.createRange();
                range.selectNodeContents(textArea);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                textArea.setSelectionRange(0, 999999); // For mobile devices
                
                const success = document.execCommand('copy');
                document.body.removeChild(textArea);
                
                if (success) {
                    return { success: true, method: 'execCommand' };
                }
            } catch (e) {
                console.log('execCommand fallback failed:', e);
            }
            
            // Method 3: Show URL for manual copy
            return { success: false, url: text };
        }

        // Show URL modal for manual copying (fallback)
        function showManualCopyModal(url) {
            const existingModal = document.getElementById('manual-copy-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modal = document.createElement('div');
            modal.id = 'manual-copy-modal';
            modal.className = 'modal-overlay visible';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>Share Link Ready</h3>
                    <p>Long-press to copy the link below:</p>
                    <input type="text" value="${url}" readonly id="manual-copy-input" 
                           style="font-size: 14px; word-break: break-all;">
                    <div class="modal-buttons">
                        <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">
                            Done
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Auto-select the text
            const input = document.getElementById('manual-copy-input');
            input.focus();
            input.select();
        }

        // Try Again button handler (no wines found)
        tryAgainBtn.addEventListener('click', () => {
            hideNoWinesFound();
            // Reset file input
            currentFile = null;
            currentBase64 = null;
            isImageReady = false;
            previewSection.classList.remove('active');
            uploadSection.style.display = 'block';
            analyzeBtn.disabled = false;
            analyzeBtn.textContent = 'Analyze Menu';
            // Trigger file picker
            fileInput.click();
        });
        
        // Error retry button handler - retry with same image
        errorRetryBtn.addEventListener('click', () => {
            hideError();
            // If we have an image loaded, just retry the analysis
            if (currentBase64) {
                analyzeBtn.click();
            } else {
                // Otherwise, let them pick a new file
                fileInput.click();
            }
        });

        // Helper function to safely extract media type and image data from base64 data URL
        function parseDataUrl(dataUrl) {
            // Default values
            let mediaType = 'image/jpeg';
            let imageData = dataUrl;
            
            if (!dataUrl || typeof dataUrl !== 'string') {
                return { mediaType, imageData: '' };
            }
            
            // Check if it's a data URL format: data:image/type;base64,DATA
            if (dataUrl.startsWith('data:')) {
                try {
                    // Extract media type
                    const match = dataUrl.match(/^data:([^;,]+)/);
                    if (match && match[1]) {
                        mediaType = match[1];
                    }
                    
                    // Extract base64 data (after the comma)
                    const commaIndex = dataUrl.indexOf(',');
                    if (commaIndex !== -1) {
                        imageData = dataUrl.substring(commaIndex + 1);
                    }
                } catch (e) {
                    console.warn('Error parsing data URL, using defaults:', e);
                }
            }
            
            return { mediaType, imageData };
        }

        // Step 1: Extract wines from image (Claude only)
        analyzeBtn.addEventListener('click', async () => {
            if (!currentBase64 || !isImageReady) {
                showError('Please wait for the image to fully load');
                return;
            }
            
            // Hide any previous no-wines state
            hideNoWinesFound();

            hideError();
            showLoading(1, 'Scanning menu...', 'AI is reading your wine list');

            try {
                // Safely extract media type and image data
                const { mediaType, imageData } = parseDataUrl(currentBase64);
                
                // Create AbortController for timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 90000); // 90 second timeout
                
                let response;
                try {
                    // Get user context if provided
                    const contextInput = document.getElementById('context-input');
                    const userContext = contextInput ? contextInput.value.trim() : '';
                    
                    // Step 1: Extract wines only (no price lookup)
                    response = await fetch('/extract', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            image: currentBase64,
                            media_type: mediaType,
                            context: userContext
                        }),
                        signal: controller.signal
                    });
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    if (fetchError.name === 'AbortError') {
                        throw {
                            type: 'timeout',
                            message: 'The request took too long. Please try with a smaller image.',
                            suggestions: [
                                'Try uploading a smaller image',
                                'Crop the image to focus on the wine list',
                                'Ensure good image quality'
                            ]
                        };
                    }
                    throw {
                        type: 'network',
                        message: 'Could not connect to the server. Please check your internet connection.',
                        suggestions: [
                            'Check your internet connection',
                            'Try again in a few moments'
                        ]
                    };
                }
                clearTimeout(timeoutId);

                const data = await response.json();

                // Handle specific error types from backend
                if (!response.ok || data.error) {
                    const errorType = data.error || 'unknown';
                    
                    // Special case: no wines found (show helpful UI)
                    if (errorType === 'no_wines_found') {
                        hideLoading();
                        showNoWinesFound(data.suggestions);
                        return;
                    }
                    
                    // Throw structured error for other cases
                    throw {
                        type: errorType,
                        message: data.error_message || 'Analysis failed',
                        suggestions: data.suggestions || []
                    };
                }
                
                // Check if wines array is empty
                if (!data.wines || data.wines.length === 0) {
                    hideLoading();
                    showNoWinesFound();
                    return;
                }

                // Show discovered wines briefly
                const winePreview = data.wines.map(w => ({
                    name: w.name || w.original_name,
                    vintage: w.vintage,
                    price: w.menu_price
                }));
                showDiscoveredWines(winePreview);
                
                // Wait a moment to let user see the wines found
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Hide loading and show wine selection modal
                hideLoading();
                showWineSelectionModal(data.wines);

            } catch (error) {
                // Handle structured errors with suggestions
                if (error.type && error.suggestions) {
                    showErrorWithSuggestions(error.message, error.suggestions, error.type);
                } else {
                    // Fallback for simple error strings
                    showError(error.message || 'An unexpected error occurred');
                }
                hideLoading();
            }
        });

        // Step 2: Look up prices for selected wines
        proceedLookupBtn.addEventListener('click', async () => {
            const selectedWines = getSelectedWines();
            
            if (selectedWines.length === 0) {
                return;
            }
            
            // Hide modal and show loading with progress
            hideWineSelectionModal();
            showLoading(2, 'Looking up ' + selectedWines.length + ' wines...', 'Searching Wine Labs database');
            
            // Start the progress display
            startLookupProgress(selectedWines);
            
            try {
                // Create AbortController for timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 second timeout for lookup
                
                let response;
                try {
                    response = await fetch('/lookup', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            wines: selectedWines
                        }),
                        signal: controller.signal
                    });
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    if (fetchError.name === 'AbortError') {
                        throw {
                            type: 'timeout',
                            message: 'Price lookup took too long. Please try again with fewer wines.',
                            suggestions: [
                                'Select fewer wines',
                                'Try again in a few moments'
                            ]
                        };
                    }
                    throw {
                        type: 'network',
                        message: 'Could not connect to the server. Please check your internet connection.',
                        suggestions: [
                            'Check your internet connection',
                            'Try again in a few moments'
                        ]
                    };
                }
                clearTimeout(timeoutId);
                
                const data = await response.json();
                
                // Handle errors
                if (!response.ok || data.error) {
                    throw {
                        type: data.error || 'unknown',
                        message: data.error_message || 'Price lookup failed',
                        suggestions: data.suggestions || []
                    };
                }
                
                // Show lookup results in progress panel
                if (data.wines && data.wines.length > 0) {
                    // Update status to show we got results
                    loadingStatus.textContent = 'Got results! Processing...';
                    finishLookupProgress(data.wines);
                    // Give user a moment to see the results
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
                
                // Update to step 3
                showLoading(3, 'Building results...', 'Calculating markups and sorting');
                await new Promise(resolve => setTimeout(resolve, 300));

                // Display results
                displayResults(data);

            } catch (error) {
                // Handle structured errors with suggestions
                if (error.type && error.suggestions) {
                    showErrorWithSuggestions(error.message, error.suggestions, error.type);
                } else {
                    // Fallback for simple error strings
                    showError(error.message || 'An unexpected error occurred');
                }
            } finally {
                hideLoading();
            }
        });

        function renderWinesTable() {
            const sortedWines = sortWines(winesData, currentSort.field, currentSort.direction);
            
            resultsBody.innerHTML = '';

            sortedWines.forEach((wine, index) => {
                // Main wine row
                const row = document.createElement('tr');
                row.className = 'wine-row';
                row.dataset.index = index;
                
                const nameClass = wine.matched ? 'wine-name' : 'wine-name wine-unmatched';
                const displayName = wine.wine_name || wine.display_name || wine.original_name;
                const hasListings = wine.listings && wine.listings.length > 0;
                const expandIcon = hasListings ? '<span class="expand-icon">‚ñ∂</span>' : '<span class="expand-icon" style="visibility:hidden">‚ñ∂</span>';
                
                const glassClass = wine.is_glass ? ' is-glass' : '';
                const vintageDisplay = wine.vintage || '';
                
                // Format matched wine name - show matched name or "No match" indicator
                const matchedWineName = wine.matched_wine_name 
                    ? `<span class="matched-wine-text">${wine.matched_wine_name}</span>`
                    : '<span class="no-match">No match</span>';
                
                // For mobile: show matched wine below menu wine if matched
                const mobileMatchedHtml = wine.matched_wine_name 
                    ? `<span class="mobile-matched">‚Üí ${wine.matched_wine_name}</span>` 
                    : '<span class="mobile-matched no-match">‚Üí No match</span>';
                
                row.innerHTML = `
                    <td class="${nameClass}" data-label="Menu Wine">${expandIcon}${displayName}${vintageDisplay ? `<span class="mobile-vintage">${vintageDisplay}</span>` : ''}${mobileMatchedHtml}</td>
                    <td class="matched-wine hide-mobile" data-label="Matched">${matchedWineName}</td>
                    <td class="wine-vintage hide-mobile">${wine.vintage || '<span class="na">‚Äî</span>'}</td>
                    <td class="price price-menu${glassClass}" data-label="Menu">${formatMenuPrice(wine)}</td>
                    <td class="price price-retail" data-label="Retail">${formatPrice(wine.retail_price)}${formatSourceBadge(wine.price_source)}</td>
                    <td class="markup-cell" data-label="Markup">${formatMarkupCombined(wine.markup_percent, wine.markup_dollars)}</td>
                `;
                
                resultsBody.appendChild(row);
                
                // Detail row (hidden by default)
                if (hasListings) {
                    const detailRow = document.createElement('tr');
                    detailRow.className = 'listings-detail-row';
                    detailRow.dataset.index = index;
                    
                    let listingsHtml = `
                        <td colspan="6">
                            <div class="listings-detail-content">
                                <table class="listings-detail-table">
                                    <thead>
                                        <tr>
                                            <th>Retailer</th>
                                            <th>Price</th>
                                            <th>Location</th>
                                            <th>Link</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    wine.listings.forEach(listing => {
                        const retailerName = listing.retailer || 'Unknown';
                        const price = listing.price ? `$${listing.price.toFixed(2)}` : 'N/A';
                        const location = listing.state || '‚Äî';
                        const linkHtml = listing.url 
                            ? `<a href="${listing.url}" target="_blank" class="listing-link">View ‚Üí</a>`
                            : '‚Äî';
                        
                        listingsHtml += `
                                        <tr>
                                            <td class="listing-retailer">${retailerName}</td>
                                            <td class="listing-price">${price}</td>
                                            <td class="listing-location">${location}</td>
                                            <td>${linkHtml}</td>
                                        </tr>
                        `;
                    });
                    
                    listingsHtml += `
                                    </tbody>
                                </table>
                            </div>
                        </td>
                    `;
                    
                    detailRow.innerHTML = listingsHtml;
                    resultsBody.appendChild(detailRow);
                    
                    // Add click handler for expanding
                    row.addEventListener('click', () => {
                        row.classList.toggle('expanded');
                        detailRow.classList.toggle('visible');
                    });
                }
            });
        }

        function displayResults(data) {
            // Store wines data for sorting
            winesData = data.wines;
            
            // Store full results for sharing
            currentResults = data;
            
            // Update meta info
            totalWinesSpan.innerHTML = `${ICONS.wine} ${data.total_wines} wine${data.total_wines !== 1 ? 's' : ''} found`;
            matchedWinesSpan.innerHTML = `${ICONS.check} ${data.matched_wines} matched`;

            // Reset sort to default (markup % asc - best deals first)
            currentSort = { field: 'markup_percent', direction: 'asc' };
            updateSortUI('markup_percent');
            
            // Render table
            renderWinesTable();

            // Show results section and share button
            previewSection.classList.remove('active');
            resultsSection.classList.add('active');
            shareBtn.style.display = 'inline-flex';
        }

        // Set up sortable column click handlers
        document.querySelectorAll('.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const field = th.dataset.sort;
                handleSort(field);
            });
        });
    </script>
</body>
</html>
